services:
  freeswitch:
    image: freeswitch:latest
    container_name: freeswitch
    restart: unless-stopped
    # Use host networking
    network_mode: "host"
    volumes:
      - ./freeswitch:/usr/local/freeswitch/etc/freeswitch
      - ./freeswitch-sounds:/usr/share/freeswitch/sounds
      # Compatibility mount: many FreeSWITCH images resolve prompts via sound_prefix at /usr/local/freeswitch/share/freeswitch/sounds
      - ./freeswitch-sounds:/usr/local/freeswitch/share/freeswitch/sounds
    # Port mappings are ignored in host mode, so they are removed
    environment:
      - TZ=Asia/Tbilisi

  sip-rtp-go:
    image: sip-rtp-go:latest
    container_name: sip-rtp-go
    restart: unless-stopped
    # Must be host networking because freeswitch is host networking (127.0.0.1 SIP/RTP)
    network_mode: "host"
    environment:
      # In WSL host-network mode, FreeSWITCH binds to the WSL IP (not always 127.0.0.1).
      # Use "auto" so sip-rtp-go discovers the correct local IP and talks to FreeSWITCH reliably.
      - SIP_SERVER_ADDR=auto:5060
      - SIP_DOMAIN=auto
      - SIP_USER=1098
      - SIP_PASS=1234
      - SIP_LISTEN_ADDR=0.0.0.0:5090
      - SIP_REGISTER_LOCAL_ADDR=0.0.0.0:5091
      - SIP_CONTACT_HOST=auto
      - RTP_LISTEN_ADDR=0.0.0.0:40000
      - SDP_IP=auto
      - REGISTER_EXPIRES=300
      - LOG_LEVEL=info

  fs-admin-backend:
    image: node:20-bookworm-slim
    container_name: fs-admin-backend
    working_dir: /app
    restart: unless-stopped
    # Use host networking so ESL can reach FreeSWITCH (also in host mode) via 127.0.0.1
    network_mode: "host"
    environment:
      - PORT=3001
      - CORS_ORIGIN=http://localhost:4200
      - DB_PATH=/data/admin.sqlite
      - BACKUPS_DIR=/data/backups
      # Disable built-in mod_audio_stream *test* server in admin-panel backend to avoid port conflicts.
      # We'll run a dedicated ws-audio-test service on :9096 instead.
      - AUDIO_STREAM_TEST_ENABLED=false
      # use the same path FreeSWITCH uses (mounted from repo-root ./freeswitch)
      - FS_CONF_DIR=/usr/local/freeswitch/etc/freeswitch
      # sounds directory inside container (mounted from repo-root ./freeswitch-sounds)
      - FS_SOUND_DIR=/usr/share/freeswitch/sounds
      - ESL_HOST=127.0.0.1
      - ESL_PORT=8021
      - ESL_PASSWORD=ClueCon
      - ESL_TIMEOUT_MS=2500
      - JWT_SECRET=change-me
      - JWT_EXPIRES_IN=12h
      - ADMIN_DEFAULT_USERNAME=admin
      - ADMIN_DEFAULT_PASSWORD=admin1234
      # (removed) WS echo test server for mod_audio_stream
    volumes:
      - ./admin-panel/backend/dist:/app/dist:ro
      - ./admin-panel/backend/package.json:/app/package.json:ro
      - ./admin-panel/backend/package-lock.json:/app/package-lock.json:ro
      - fs_admin_backend_node_modules:/app/node_modules
      - ./freeswitch:/usr/local/freeswitch/etc/freeswitch
      - ./freeswitch-sounds:/usr/share/freeswitch/sounds
      - ./admin-panel/data:/data
    command: >
      sh -lc "
        if [ ! -d node_modules ] || [ ! -f node_modules/.deps_installed ]; then
          echo 'Installing backend dependencies (first run only)...';
          npm ci --omit=dev && touch node_modules/.deps_installed;
        fi;
        node dist/main.js
      "

  fs-admin-frontend:
    image: nginx:alpine
    container_name: fs-admin-frontend
    restart: unless-stopped
    ports:
      - "4200:4200"
    volumes:
      - ./admin-panel/frontend/dist/frontend/browser:/usr/share/nginx/html:ro
      - ./admin-panel/frontend/nginx.default.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  fs_admin_backend_node_modules: # (no extra volumes)
