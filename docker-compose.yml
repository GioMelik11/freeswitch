services:
  freeswitch:
    image: freeswitch:latest
    container_name: freeswitch
    restart: unless-stopped
    # Use host networking
    network_mode: "host"
    volumes:
      - ./freeswitch:/usr/local/freeswitch/etc/freeswitch
      - ./freeswitch-sounds:/usr/share/freeswitch/sounds
      # Compatibility mount: many FreeSWITCH images resolve prompts via sound_prefix at /usr/local/freeswitch/share/freeswitch/sounds
      - ./freeswitch-sounds:/usr/local/freeswitch/share/freeswitch/sounds
    # Port mappings are ignored in host mode, so they are removed
    environment:
      - TZ=Asia/Tbilisi

  fs-admin-backend:
    image: node:20-bookworm-slim
    container_name: fs-admin-backend
    working_dir: /app
    restart: unless-stopped
    # Use host networking so ESL can reach FreeSWITCH (also in host mode) via 127.0.0.1
    network_mode: "host"
    environment:
      - PORT=3001
      - CORS_ORIGIN=http://localhost:4200
      - DB_PATH=/data/admin.sqlite
      - BACKUPS_DIR=/data/backups
      # Disable built-in mod_audio_stream *test* server in admin-panel backend to avoid port conflicts.
      # We'll run a dedicated ws-audio-test service on :9096 instead.
      - AUDIO_STREAM_TEST_ENABLED=false
      # use the same path FreeSWITCH uses (mounted from repo-root ./freeswitch)
      - FS_CONF_DIR=/usr/local/freeswitch/etc/freeswitch
      # sounds directory inside container (mounted from repo-root ./freeswitch-sounds)
      - FS_SOUND_DIR=/usr/share/freeswitch/sounds
      - ESL_HOST=127.0.0.1
      - ESL_PORT=8021
      - ESL_PASSWORD=ClueCon
      - ESL_TIMEOUT_MS=2500
      - JWT_SECRET=change-me
      - JWT_EXPIRES_IN=12h
      - ADMIN_DEFAULT_USERNAME=admin
      - ADMIN_DEFAULT_PASSWORD=admin1234
    volumes:
      - ./admin-panel/backend/dist:/app/dist:ro
      - ./admin-panel/backend/package.json:/app/package.json:ro
      - ./admin-panel/backend/package-lock.json:/app/package-lock.json:ro
      - fs_admin_backend_node_modules:/app/node_modules
      - ./freeswitch:/usr/local/freeswitch/etc/freeswitch
      - ./freeswitch-sounds:/usr/share/freeswitch/sounds
      - ./admin-panel/data:/data
    command: >
      sh -lc "
        if [ ! -d node_modules ] || [ ! -f node_modules/.deps_installed ]; then
          echo 'Installing backend dependencies (first run only)...';
          npm ci --omit=dev && touch node_modules/.deps_installed;
        fi;
        node dist/main.js
      "

  # Standalone WS server for mod_audio_stream testing (echo + wav streaming) - runs on the WSL host network.
  ws-audio-test:
    image: node:20-bookworm-slim
    container_name: ws-audio-test
    working_dir: /app
    restart: unless-stopped
    network_mode: "host"
    environment:
      - PORT=9096
      - FS_SOUND_DIR=/usr/share/freeswitch/sounds
      # Optional raw streaming settings (used by /raw):
      # - RAW_FILE=raw/incoming.s16le
      # - RAW_RATE=8000
    volumes:
      - ./ws-audio-test:/app
      - ws_audio_test_node_modules:/app/node_modules
      - ./freeswitch-sounds:/usr/share/freeswitch/sounds:ro
    command: >
      sh -lc "
        if [ ! -d node_modules ] || [ ! -f node_modules/.deps_installed ]; then
          echo 'Installing ws-audio-test dependencies (first run only)...';
          npm install --omit=dev && touch node_modules/.deps_installed;
        fi;
        node server.js
      "

  # Standalone TCP server compatible with freeswitch/freeswitch/scripts/audio_socket_client.lua
  # (echoes PCM16 frames back so you should hear echo on the call).
  tcp-audio-test:
    image: node:20-bookworm-slim
    container_name: tcp-audio-test
    working_dir: /app
    restart: unless-stopped
    network_mode: "host"
    environment:
      - HOST=0.0.0.0
      - PORT=9098
    volumes:
      - ./tcp-audio-test:/app:ro
    command: >
      sh -lc "node server.js"

  fs-admin-frontend:
    image: nginx:alpine
    container_name: fs-admin-frontend
    restart: unless-stopped
    ports:
      - "4200:4200"
    volumes:
      - ./admin-panel/frontend/dist/frontend/browser:/usr/share/nginx/html:ro
      - ./admin-panel/frontend/nginx.default.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  fs_admin_backend_node_modules:
  ws_audio_test_node_modules:
