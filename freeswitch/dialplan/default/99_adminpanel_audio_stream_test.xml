<include>
    <!--
    Test endpoints.

    - 9998: FreeSWITCH built-in echo (no backend required)
    - 9999: mod_audio_stream WAV playback test (requires WS server)
    - 9997: mod_audio_stream echo test (requires WS server that echoes binary PCM back)

    WS base URL is configured via the global variable $${audio_stream_test_url}
    (see freeswitch/vars.xml).
  -->

    <!-- Echo test (built-in): dial 9998 and you should hear your own voice echoed back -->
    <extension name="echo_test_9998">
        <condition field="destination_number" expression="^9998$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <action application="echo"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- Quick WS test: dial 9999 and you should hear ivr/incoming.wav streamed via mod_audio_stream -->
    <extension name="adminpanel_audio_stream_test_9999">
        <condition field="destination_number" expression="^9999$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <action application="set" data="STREAM_SUPPRESS_LOG=true"/>
            <action application="set" data="audio_stream_test_url=$${audio_stream_test_url}"/>
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/start_audio_stream_test.lua /wav mixed 8000"/>
            <action application="sleep" data="10000"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- WS echo test: dial 9997 and you should hear your own voice echoed back (requires WS server /echo handler) -->
    <extension name="adminpanel_audio_stream_echo_9997">
        <condition field="destination_number" expression="^9997$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <!-- Keep logs enabled here: if WS is unreachable you want to see mod_audio_stream errors -->
            <action application="set" data="STREAM_SUPPRESS_LOG=false"/>
            <action application="set" data="audio_stream_test_url=$${audio_stream_test_url}"/>
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/start_audio_stream_test.lua /echo mixed 8000"/>
            <action application="sleep" data="15000"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- Local WAV test (no WS): dial 9996 and you should hear ivr/incoming.wav played by FreeSWITCH -->
    <extension name="local_wav_test_9996">
        <condition field="destination_number" expression="^9996$">
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/play_test_wav.lua ivr/incoming.wav"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- WS raw PCM16 test: dial 9995 and server streams raw bytes from /raw (no wav parsing) -->
    <extension name="adminpanel_audio_stream_raw_9995">
        <condition field="destination_number" expression="^9995$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <action application="set" data="STREAM_SUPPRESS_LOG=false"/>
            <action application="set" data="audio_stream_test_url=$${audio_stream_test_url}"/>
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/start_audio_stream_test.lua /raw mixed 8000"/>
            <action application="sleep" data="10000"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- WS tone test: dial 9994 and you should hear a 1kHz beep streamed from WS (/tone) -->
    <extension name="adminpanel_audio_stream_tone_9994">
        <condition field="destination_number" expression="^9994$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <action application="set" data="STREAM_SUPPRESS_LOG=false"/>
            <action application="set" data="audio_stream_test_url=$${audio_stream_test_url}"/>
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/start_audio_stream_test.lua /tone mono 8000"/>
            <action application="sleep" data="10000"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- TCP AudioSocket echo test (no WebSocket): dial 9993 and you should hear your own voice echoed back -->
    <extension name="audiosocket_echo_9993">
        <condition field="destination_number" expression="^9993$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <action application="set" data="STREAM_SUPPRESS_LOG=false"/>
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/audio_socket_client.lua ${uuid} 127.0.0.1 9098"/>
            <!-- If the Lua script exits early due to an error, keep the call open a bit for debugging -->
            <action application="sleep" data="30000"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- HTTP download + playback test (no WS playback): dial 9992 -->
    <extension name="http_download_playback_9992">
        <condition field="destination_number" expression="^9992$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <!-- Download a wav from local http server into /tmp and play it -->
            <action application="system" data="curl -sS --fail http://127.0.0.1:9099/?file=ivr/incoming.wav -o /tmp/http_test.wav"/>
            <action application="playback" data="/tmp/http_test.wav"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- TCP AudioSocket echo test (no mod_audio_stream playback needed): dial 9993 and you should hear echo -->
    <extension name="tcp_audio_socket_echo_9993">
        <condition field="destination_number" expression="^9993$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <action application="set" data="STREAM_SUPPRESS_LOG=false"/>
            <!-- audio_socket_client.lua strips dashes from UUID itself -->
            <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/audio_socket_client.lua ${uuid} 127.0.0.1 9098"/>
            <action application="hangup"/>
        </condition>
    </extension>

    <!-- File-based playback test (Option C): put a WAV at freeswitch-sounds/tmp/incoming.wav and dial 9992 -->
    <extension name="file_playback_test_9992">
        <condition field="destination_number" expression="^9992$">
            <action application="answer"/>
            <action application="sleep" data="300"/>
            <!-- Try a user-provided file first (shared volume), then play a known-good built-in prompt -->
            <action application="playback" data="tmp/incoming.wav"/>
            <action application="playback" data="ivr/incoming.wav"/>
            <action application="hangup"/>
        </condition>
    </extension>
</include>


