<?xml version="1.0" encoding="utf-8"?>
<!--
    Public Context for Inbound Calls
    Handles calls from external SIP trunks
-->
<include>
  <context name="public">

    <!-- Admin Panel generated inbound routes (must come before catch-alls) -->
    <X-PRE-PROCESS cmd="include" data="public/*.xml"/>

    <!-- Inbound DID routing - Route to AI Voice Service (commented out - use IVR instead) -->
    <!--
    <extension name="Inbound_DID_AI">
      <condition field="destination_number" expression="^(.*)$">
        <!-- Route to AI Voice Service (backend AudioSocket on port 9094) -->
    <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
    <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
    <action application="answer"/>
    <action application="sleep" data="500"/>
    <action application="set" data="STREAM_SUPPRESS_LOG=true"/>
    <!-- Start WebSocket audio stream to backend (mod_audio_stream) -->
    <action application="lua" data="/usr/local/freeswitch/etc/freeswitch/scripts/start_audio_stream.lua $${audio_stream_url} mono 16k"/>
    <!-- Keep channel open while streaming; caller can hang up anytime -->
    <action application="sleep" data="3600000"/>
    <action application="hangup"/>
  </condition>
</extension>
    -->

<!-- Route to IVR - Fallback for inbound calls (commented out - use admin panel trunk settings instead) -->
<!--
    <extension name="Inbound_DID">
      <condition field="destination_number" expression="^(.*)$">
        <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
        <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
        <action application="transfer" data="5000 XML default"/>
      </condition>
    </extension>
    -->

<!-- Route specific DIDs to specific extensions -->
<extension name="Extension_1001">
  <condition field="destination_number" expression="^2200405$">
    <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
    <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
    <action application="transfer" data="1001 XML default"/>
  </condition>
</extension>

<extension name="Extension_1003">
  <condition field="destination_number" expression="^2200406$">
    <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
    <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
    <action application="transfer" data="1003 XML default"/>
  </condition>
</extension>

<!-- Outbound calls from external context -->
<extension name="External_Outbound_Calls">
  <condition field="destination_number" expression="^(\+?[1-9][0-9]{7,14})$">
    <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
    <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
    <action application="set" data="ringback=${adminpanel_outgoing_sound:-${adminpanel_trunk_outgoing_sound:-${us-ring}}}"/>
    <action application="lua" data="adminpanel_outgoing_ivr.lua"/>
    <action application="set" data="call_timeout=60"/>
    <action application="set" data="hangup_after_bridge=true"/>
    <action application="set" data="continue_on_fail=true"/>
    <action application="bridge" data="sofia/gateway/sip_trunk_provider/$1"/>
  </condition>
</extension>

<!-- Specific DID routing examples -->
<extension name="Support_DID">
  <condition field="destination_number" expression="^\+1([0-9]{10})$">
    <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
    <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
    <action application="transfer" data="2000 XML default"/>
  </condition>
</extension>

<extension name="Sales_DID">
  <condition field="destination_number" expression="^\+1([0-9]{10})$">
    <action application="set" data="effective_caller_id_number=${caller_id_number}"/>
    <action application="set" data="effective_caller_id_name=${caller_id_name}"/>
    <action application="transfer" data="2001 XML default"/>
  </condition>
</extension>

</context>
</include>